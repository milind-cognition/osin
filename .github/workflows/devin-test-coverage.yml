name: Devin Test Coverage

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  trigger-devin-test-coverage:
    runs-on: ubuntu-latest
    # Skip PRs whose branch name contains 'devin-test-coverage'
    # to avoid the test-coverage session re-triggering on its
    # own follow-up PRs
    if: >-
      !contains(github.head_ref, 'devin-test-coverage')
    steps:
      - name: Build prompt and trigger Devin session
        id: devin
        uses: actions/github-script@v7
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prUrl = context.payload.pull_request.html_url;
            const repo =
              `${context.repo.owner}/${context.repo.repo}`;
            const branch = context.payload.pull_request.head.ref;

            // Fetch changed files
            const { data: files } =
              await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100,
              });

            const changedFiles = files
              .map(f =>
                `${f.status}: ${f.filename} `
                + `(+${f.additions}/-${f.deletions})`
              )
              .join('\n');

            // Build prompt in JS to avoid shell injection
            const prompt = [
              `You are reviewing PR #${prNumber}`,
              `("${prTitle}") in the repository ${repo}.`,
              ``,
              `PR URL: ${prUrl}`,
              `Branch: ${branch}`,
              ``,
              `The following files were changed in this PR:`,
              changedFiles,
              ``,
              `Your task:`,
              `1. First, determine whether this PR contains`,
              `   changes that would benefit from additional`,
              `   test coverage. Changes that typically benefit`,
              `   include: new functions/methods, bug fixes,`,
              `   new features, refactored logic, or changed`,
              `   behavior. Changes that typically do NOT need`,
              `   tests include: documentation-only changes,`,
              `   CI/CD config changes, dependency bumps, or`,
              `   cosmetic/formatting changes.`,
              ``,
              `2. If the PR does NOT justify additional test`,
              `   coverage, briefly explain why and end the`,
              `   session.`,
              ``,
              `3. If the PR DOES justify additional test`,
              `   coverage:`,
              `   a. Check out the PR branch.`,
              `   b. Analyze the changed code to understand`,
              `      what is being added or modified.`,
              `   c. Review existing tests to understand`,
              `      current coverage and testing patterns.`,
              `   d. Write new tests or extend existing tests`,
              `      to cover the changes introduced by this`,
              `      PR.`,
              `   e. Follow the existing test conventions in`,
              `      the repo (test framework, file naming,`,
              `      assertion style, etc.).`,
              `   f. Make sure all tests pass (existing and`,
              `      new).`,
              `   g. Create a new PR that targets the same`,
              `      branch (${branch}) with the additional`,
              `      test coverage. Name your branch with a`,
              `      'devin-test-coverage/' prefix.`,
              `   h. Reference the original PR #${prNumber}`,
              `      in your PR description.`,
              ``,
              `Testing guidelines:`,
              `- Follow the testing pyramid: prefer unit tests.`,
              `- Tests should be independent and not rely on`,
              `  execution order.`,
              `- Use descriptive test names that explain the`,
              `  scenario.`,
              `- Mock external dependencies.`,
              `- Test edge cases and error conditions, not just`,
              `  happy paths.`,
              `- Aim for meaningful coverage, not 100% coverage.`,
              `- Keep tests fast.`,
              `- Test behavior, not implementation details.`,
            ].join('\n');

            // Call Devin API (v1 for personal API keys)
            const apiKey = process.env.DEVIN_API_KEY;
            if (!apiKey) {
              core.setFailed('DEVIN_API_KEY secret is not set.');
              return;
            }

            const response = await fetch(
              'https://api.devin.ai/v1/sessions',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt }),
              }
            );

            const body = await response.json();

            if (!response.ok) {
              core.setFailed(
                `Devin API returned ${response.status}: `
                + JSON.stringify(body)
              );
              return;
            }

            const sessionUrl =
              body.url || body.session_url || 'N/A';
            const sessionId =
              body.session_id || body.id || 'N/A';

            core.info(`Devin session created: ${sessionId}`);
            core.info(`Session URL: ${sessionUrl}`);
            core.setOutput('session_url', sessionUrl);
            core.setOutput('session_id', sessionId);

      - name: Comment on PR
        if: >-
          success()
          && steps.devin.outputs.session_url != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sessionUrl =
              `${{ steps.devin.outputs.session_url }}`;
            const marker =
              '<!-- devin-test-coverage-bot -->';

            const body = [
              marker,
              '**Devin Test Coverage** - A Devin session has',
              'been triggered to analyze this PR and add test',
              'coverage if needed.',
              '',
              `[View Devin session](${sessionUrl})`,
            ].join('\n');

            // Update existing comment to avoid spam on
            // synchronize events
            const { data: comments } =
              await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number:
                  context.payload.pull_request.number,
                per_page: 100,
              });

            const existing = comments.find(
              c => c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number:
                  context.payload.pull_request.number,
                body,
              });
            }
