name: Devin Test Coverage

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  trigger-devin-test-coverage:
    runs-on: ubuntu-latest
    # Skip PRs created by Devin to avoid infinite loops
    if: "!contains(github.head_ref, 'devin/')"
    steps:
      - name: Get PR diff
        id: pr_diff
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const changedFiles = files.map(f => `${f.status}: ${f.filename} (+${f.additions}/-${f.deletions})`).join('\n');
            core.setOutput('changed_files', changedFiles);

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body || '');

      - name: Trigger Devin session for test coverage
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ steps.pr_diff.outputs.pr_title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.head_ref }}"
          CHANGED_FILES="${{ steps.pr_diff.outputs.changed_files }}"

          PROMPT=$(cat <<'EOF'
          You are reviewing PR #__PR_NUMBER__ ("__PR_TITLE__") in the repository __REPO__.

          PR URL: __PR_URL__
          Branch: __BRANCH__

          The following files were changed in this PR:
          __CHANGED_FILES__

          Your task:
          1. First, determine whether this PR contains changes that would benefit from additional test coverage. Changes that typically benefit include: new functions/methods, bug fixes, new features, refactored logic, or changed behavior. Changes that typically do NOT need tests include: documentation-only changes, CI/CD config changes, dependency bumps, or cosmetic/formatting changes.

          2. If the PR does NOT justify additional test coverage, briefly explain why and end the session.

          3. If the PR DOES justify additional test coverage:
             a. Check out the PR branch.
             b. Analyze the changed code to understand what is being added or modified.
             c. Review existing tests to understand current coverage and testing patterns.
             d. Write new tests or extend existing tests to cover the changes introduced by this PR.
             e. Follow the existing test conventions in the repo (test framework, file naming, assertion style, etc.).
             f. Make sure all tests pass (existing and new).
             g. Create a new PR that targets the same branch (__BRANCH__) with the additional test coverage.
             h. Reference the original PR #__PR_NUMBER__ in your PR description.

          Testing guidelines:
          - Follow the testing pyramid: prefer unit tests.
          - Tests should be independent and not rely on execution order.
          - Use descriptive test names that explain the scenario.
          - Mock external dependencies.
          - Test edge cases and error conditions, not just happy paths.
          - Aim for meaningful coverage, not 100% coverage.
          - Keep tests fast.
          - Test behavior, not implementation details.
          EOF
          )

          # Substitute placeholders
          PROMPT="${PROMPT//__PR_NUMBER__/$PR_NUMBER}"
          PROMPT="${PROMPT//__PR_TITLE__/$PR_TITLE}"
          PROMPT="${PROMPT//__PR_URL__/$PR_URL}"
          PROMPT="${PROMPT//__REPO__/$REPO}"
          PROMPT="${PROMPT//__BRANCH__/$BRANCH}"
          PROMPT="${PROMPT//__CHANGED_FILES__/$CHANGED_FILES}"

          # Create Devin session via v3 API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.devin.ai/v3/organizations/sessions" \
            -H "Authorization: Bearer ${DEVIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{prompt: $prompt}')")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            SESSION_URL=$(echo "$BODY" | jq -r '.url // .session_url // "N/A"')
            SESSION_ID=$(echo "$BODY" | jq -r '.session_id // .id // "N/A"')
            echo "Devin session created successfully!"
            echo "Session ID: $SESSION_ID"
            echo "Session URL: $SESSION_URL"
          else
            echo "Failed to create Devin session (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '**Devin Test Coverage** - A Devin session has been triggered to analyze this PR and add test coverage if needed. You can monitor the session in your [Devin dashboard](https://app.devin.ai).'
            });
